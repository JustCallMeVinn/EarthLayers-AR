<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Edukasi Lapisan Bumi 3D</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>

    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
        body{background:#000;overflow:hidden;height:100vh;color:#fff}
        .glass{background:rgba(15,15,35,0.85);backdrop-filter:blur(16px);border-radius:16px;border:1px solid rgba(255,255,255,0.1);box-shadow:0 8px 32px rgba(0,0,0,0.4)}
        
        #startScreen{position:fixed;inset:0;background:linear-gradient(135deg,#0f0c29,#302b63,#24243e);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;animation:fadeIn 1s}
        #startScreen h1{font-size:2.5em;margin-bottom:20px;color:#4CAF50;text-shadow:0 0 20px #4CAF50}
        #startScreen button{padding:18px 40px;font-size:18px;background:#4CAF50;color:#fff;border:none;border-radius:50px;cursor:pointer;margin-top:30px;box-shadow:0 10px 30px rgba(76,175,80,0.4);transition:0.3s}
        #startScreen button:hover{transform:translateY(-5px);box-shadow:0 20px 40px rgba(76,175,80,0.6)}

        #info{position:fixed;top:15px;left:15px;padding:15px 20px;max-width:320px;z-index:999}
        #info h3{font-size:18px;color:#4CAF50;margin-bottom:10px;display:flex;align-items:center;gap:10px}
        .status{padding:5px 12px;border-radius:8px;font-weight:bold;font-size:12px}
        .active{background:#4CAF50;color:#fff}
        .inactive{background:#f44336;color:#fff}
        .loading{background:#FF9800;color:#fff}

        #layerInfo{position:fixed;top:15px;right:15px;padding:20px;max-width:300px;display:none;z-index:999;animation:slideIn 0.6s}
        #layerInfo h4{color:#4CAF50;font-size:17px;margin-bottom:15px}
        .layer{margin:12px 0;padding:12px;background:rgba(255,255,255,0.08);border-radius:10px;border-left:5px solid;transition:0.3s}
        .layer:hover{transform:translateX(5px);background:rgba(255,255,255,0.15)}
        .crust{border-color:#8B4513}
        .mantle{border-color:#FF6B35}
        .outer-core{border-color:#FFC300}
        .inner-core{border-color:#FFFFFF}

        #controls{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:15px 20px;display:none;flex-direction:column;gap:15px;align-items:center;max-width:95vw;z-index:999}
        .btn-row{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
        button{padding:14px 24px;border:none;border-radius:12px;font-weight:bold;cursor:pointer;transition:all 0.3s;box-shadow:0 6px 20px rgba(0,0,0,0.3)}
        button:hover{transform:translateY(-3px)}
        button:active{transform:scale(0.95)}
        .primary{background:#4CAF50;color:#fff}
        .danger{background:#FF5722;color:#fff}
        .secondary{background:#2196F3;color:#fff}
        .slider-row{display:flex;align-items:center;gap:10px;width:100%;max-width:400px;font-size:13px}
        input[type=range]{flex:1;height:8px;border-radius:4px;background:rgba(255,255,255,0.2);outline:none}
        input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:22px;height:22px;background:#4CAF50;border-radius:50%;cursor:pointer;box-shadow:0 0 10px #4CAF50}

        #hint{position:fixed;bottom:130px;left:50%;transform:translateX(-50%);background:rgba(255,107,53,0.95);padding:14px 28px;border-radius:50px;font-weight:bold;font-size:15px;z-index:999;animation:pulse 2s infinite;display:none}
        @keyframes pulse{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.1)}}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        @keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}
    </style>
</head>
<body>

<div id="startScreen" class="glass">
    <h1>üåç Lapisan Bumi 3D</h1>
    <p style="font-size:18px;text-align:center;max-width:80%">Arahkan kamera ke marker Hiro<br>Ketuk bumi untuk melihat lapisan dalam!</p>
    <button onclick="startAR()">Mulai AR Edukatif</button>
</div>

<a-scene id="scene" embedded arjs="sourceType:webcam;debugUIEnabled:false" renderer="logarithmicDepthBuffer:true" vr-mode-ui="enabled:false" style="display:none">
    <a-marker preset="hiro" id="marker">
        <a-entity id="earth" scale="2 2 2" animation="property:rotation;to:0 360 0;loop:true;dur:15000;easing:linear"></a-entity>
    </a-marker>
    <a-entity camera></a-entity>
</a-scene>

<div id="info" class="glass">
    <h3>üåç Lapisan Bumi</h3>
    <p>Kamera: <span id="camStatus" class="status loading">Loading...</span></p>
    <p>Marker: <span id="markerStatus" class="status inactive">Cari Hiro</span></p>
    <p>Model: <span id="modelStatus" class="status inactive">Belum Upload</span></p>
    <p>Status: <span id="openStatus">Tertutup</span></p>
</div>

<div id="layerInfo" class="glass">
    <h4>üìö Informasi Lapisan Bumi</h4>
    <div class="layer crust"><strong>Kerak Bumi (Crust)</strong><br>Tebal 5‚Äì70 km</div>
    <div class="layer mantle"><strong>Mantel (Mantle)</strong><br>Tebal ~2.900 km | Suhu 1.000‚Äì3.700¬∞C</div>
    <div class="layer outer-core"><strong>Inti Luar (Outer Core)</strong><br>Cair | Tebal ~2.200 km | Suhu ~5.000¬∞C</div>
    <div class="layer inner-core"><strong>Inti Dalam (Inner Core)</strong><br>Padat | Radius ~1.220 km | Suhu ~5.200¬∞C</div>
</div>

<div id="hint">üëÜ Ketuk Bumi untuk Membelah!</div>

<div id="controls" class="glass">
    <div class="btn-row">
        <button class="primary" onclick="document.getElementById('file').click()">üìÅ Upload bumi.glb</button>
        <button class="danger" id="openBtn" onclick="toggleOpen()">üîì Buka Lapisan</button>
        <button class="secondary" id="rotBtn" onclick="toggleRot()">üîÑ Rotasi ON</button>
    </div>
    <div class="slider-row">
        <span>Ukuran:</span> <span id="scaleVal">2.0</span>x
        <input type="range" min="0.5" max="6" step="0.1" value="2" oninput="setScale(this.value)">
    </div>
    <div class="slider-row">
        <span>Buka:</span> <span id="openVal">0</span>%
        <input type="range" id="openSlider" min="0" max="100" step="2" value="0" oninput="setOpen(this.value)">
    </div>
</div>

<input type="file" id="file" accept=".glb,.gltf" style="display:none">

<script>
    let isOpen = false, progress = 0, rotationOn = true;

    AFRAME.registerComponent('earth-belahan', {
        schema: {open:{type:'number',default:0}},
        init: function(){
            this.meshes = [];
            this.initialized = false;
        },
        tick: function(){
            if(!this.initialized){
                const model = this.el.getObject3D('mesh');
                if(!model) return;
                
                this.initialized = true;
                console.log('üîç Memindai model...');
                
                model.traverse(obj => {
                    if(obj.isMesh){
                        // Simpan semua mesh dengan data aslinya
                        obj.userData.originalPosition = obj.position.clone();
                        obj.userData.originalRotation = obj.rotation.clone();
                        obj.userData.originalScale = obj.scale.clone();
                        
                        this.meshes.push({
                            mesh: obj,
                            name: obj.name,
                            nameLower: obj.name.toLowerCase()
                        });
                        
                        console.log('üì¶ Mesh ditemukan:', obj.name);
                    }
                });
                
                console.log('‚úÖ Total mesh:', this.meshes.length);
            }
            
            // Animasi setiap frame
            this.animateOpen(this.data.open);
        },
        animateOpen: function(openValue){
            const t = openValue / 100;
            
            this.meshes.forEach(item => {
                const mesh = item.mesh;
                const name = item.nameLower;
                const orig = mesh.userData.originalPosition;
                
                // Reset ke posisi original
                mesh.position.copy(orig);
                mesh.rotation.copy(mesh.userData.originalRotation);
                mesh.scale.copy(mesh.userData.originalScale);
                
                // INNER CORE - Tetap di tengah, membesar
                if(name.includes('inner')){
                    const scale = 1 + t * 1.5;
                    mesh.scale.setScalar(scale);
                    if(mesh.material){
                        mesh.material.emissive = new THREE.Color(0xffff00);
                        mesh.material.emissiveIntensity = 1 + t * 10;
                    }
                }
                // OUTER CORE - Geser sedikit ke kanan
                else if(name.includes('outer')){
                    mesh.position.x = orig.x + (t * 3);
                    mesh.rotation.y = t * Math.PI / 6;
                }
                // MANTLE - Geser lebih jauh ke kanan
                else if(name.includes('mantle')){
                    mesh.position.x = orig.x + (t * 5);
                    mesh.rotation.y = t * Math.PI / 4;
                }
                // CRUST - Deteksi kiri/kanan berdasarkan posisi X original
                else if(name.includes('crust')){
                    if(name.includes('2') || name.includes('right') || orig.x > 0){
                        // Kerak KANAN
                        mesh.position.x = orig.x + (t * 7);
                        mesh.rotation.y = t * Math.PI / 3;
                    } else {
                        // Kerak KIRI
                        mesh.position.x = orig.x - (t * 7);
                        mesh.rotation.y = -t * Math.PI / 3;
                    }
                }
                // Mesh lain yang tidak teridentifikasi - pisah berdasarkan posisi X
                else {
                    if(orig.x > 0.1){
                        mesh.position.x = orig.x + (t * 7);
                        mesh.rotation.y = t * Math.PI / 3;
                    } else if(orig.x < -0.1){
                        mesh.position.x = orig.x - (t * 7);
                        mesh.rotation.y = -t * Math.PI / 3;
                    }
                }
            });
        }
    });

    function startAR(){
        document.getElementById('startScreen').remove();
        document.getElementById('scene').style.display = 'block';
        document.getElementById('info').style.display = 'block';
        document.getElementById('controls').style.display = 'flex';
        
        setTimeout(() => {
            document.getElementById('camStatus').className = 'status active';
        }, 2000);
        
        document.querySelector('#marker').addEventListener('markerFound', () => {
            document.getElementById('markerStatus').className = 'status active';
            document.getElementById('hint').style.display = 'block';
        });
        
        document.querySelector('#marker').addEventListener('markerLost', () => {
            document.getElementById('markerStatus').className = 'status inactive';
            document.getElementById('hint').style.display = 'none';
        });
    }

    document.getElementById('file').onchange = e => {
        const f = e.target.files[0];
        if(!f) return;
        
        const url = URL.createObjectURL(f);
        const earth = document.getElementById('earth');
        
        // Hapus model lama
        earth.innerHTML = '';
        
        // Buat model baru dengan event listener
        const model = document.createElement('a-gltf-model');
        model.setAttribute('src', url);
        
        // Tunggu model selesai loading
        model.addEventListener('model-loaded', () => {
            console.log('‚úÖ Model loaded event fired');
            
            // Cek langsung apakah ada mesh
            setTimeout(() => {
                const earth = document.getElementById('earth');
                const gltfModel = earth.querySelector('a-gltf-model');
                
                if(gltfModel){
                    const obj3D = gltfModel.getObject3D('mesh');
                    console.log('üîç Checking model structure...');
                    console.log('Object3D exists:', !!obj3D);
                    
                    if(obj3D){
                        let meshCount = 0;
                        let meshNames = [];
                        
                        obj3D.traverse(o => {
                            console.log('  ‚îî‚îÄ', o.type, ':', o.name || '(unnamed)');
                            if(o.isMesh){
                                meshCount++;
                                meshNames.push(o.name);
                            }
                        });
                        
                        console.log('üìä Total meshes found:', meshCount);
                        console.log('üìù Mesh names:', meshNames);
                    }
                }
                
                // Attach component
                console.log('üîß Attaching component...');
                earth.setAttribute('earth-belahan', 'open:0');
                
                // Test component setelah 3 detik
                setTimeout(() => {
                    console.log('üß™ Testing component after 3 seconds...');
                    const component = earth.components['earth-belahan'];
                    if(component){
                        console.log('‚úì Component exists');
                        console.log('‚úì Initialized:', component.initialized);
                        console.log('‚úì Meshes detected:', component.meshes.length);
                        if(component.meshes.length > 0){
                            console.log('üéâ SUCCESS! Component is working!');
                            console.log('üëâ Now try moving the slider!');
                        } else {
                            console.log('‚ùå No meshes detected yet. Will keep trying...');
                        }
                    } else {
                        console.log('‚ùå Component not found!');
                    }
                }, 3000);
            }, 500);
        });
        
        earth.appendChild(model);
        
        document.getElementById('modelStatus').textContent = f.name.split('.')[0];
        document.getElementById('modelStatus').className = 'status active';
        
        console.log('üåç Model bumi berhasil dimuat:', f.name);
    };

    function toggleOpen(){
        isOpen = !isOpen;
        const target = isOpen ? 100 : 0;
        
        anime({
            targets: {v: progress},
            v: target,
            duration: 2400,
            easing: 'easeOutExpo',
            update: a => {
                progress = Math.round(a.animations[0].currentValue);
                setOpen(progress);
            }
        });
        
        document.getElementById('openBtn').textContent = isOpen ? 'üîí Tutup Lapisan' : 'üîì Buka Lapisan';
        document.getElementById('openStatus').textContent = isOpen ? 'Terbuka' : 'Tertutup';
        document.getElementById('layerInfo').style.display = isOpen ? 'block' : 'none';
        document.getElementById('hint').style.display = isOpen ? 'none' : 'block';
    }

    function setOpen(v){
        progress = v;
        document.getElementById('openVal').textContent = v;
        document.getElementById('openSlider').value = v;
        
        const earth = document.getElementById('earth');
        earth.setAttribute('earth-belahan', `open:${v}`);
        
        console.log('üìä Setting open value to:', v);
    }

    function setScale(v){
        document.getElementById('earth').setAttribute('scale', `${v} ${v} ${v}`);
        document.getElementById('scaleVal').textContent = parseFloat(v).toFixed(1);
    }

    function toggleRot(){
        rotationOn = !rotationOn;
        const el = document.getElementById('earth');
        
        if(rotationOn){
            el.setAttribute('animation', 'property:rotation;to:0 360 0;loop:true;dur:15000;easing:linear');
        } else {
            el.removeAttribute('animation');
        }
        
        document.getElementById('rotBtn').textContent = rotationOn ? 'üîÑ Rotasi ON' : '‚è∏Ô∏è Rotasi OFF';
    }

    // Klik pada model bumi untuk toggle buka/tutup
    document.querySelector('a-scene').addEventListener('click', e => {
        if(e.detail.intersection && document.getElementById('earth').children.length){
            toggleOpen();
        }
    });
</script>
</body>
</html>
