<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR Edukasi Lapisan Bumi 3D</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1c2407b26c61958baa93967b5412487cd94b290b/dist/aframe-master.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar-nft.js"></script>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: 'Segoe UI', sans-serif; overflow: hidden;}
        #info {position: fixed; top: 15px; left: 15px; background: rgba(0,0,0,0.85); color: white; padding: 15px 20px; border-radius: 12px; font-size: 13px; max-width: 300px; z-index: 9999; backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.3);}
        #info h3 {margin: 0 0 12px 0; font-size: 17px; color: #4CAF50; display: flex; align-items: center; gap: 8px;}
        #info p {margin: 8px 0; display: flex; justify-content: space-between; align-items: center;}
        .status {display: inline-block; padding: 4px 10px; border-radius: 5px; font-weight: bold; font-size: 11px;}
        .status.active {background: #4CAF50; color: white;}
        .status.inactive {background: #f44336; color: white;}
        .status.loading {background: #FF9800; color: white;}
        #layerInfo {position: fixed; top: 15px; right: 15px; background: rgba(0,0,0,0.9); color: white; padding: 20px; border-radius: 12px; font-size: 13px; max-width: 280px; z-index: 9999; backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); display: none;}
        #layerInfo h4 {margin: 0 0 10px 0; color: #4CAF50; font-size: 16px;}
        #layerInfo .layer {margin: 10px 0; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 6px; border-left: 4px solid;}
        #layerInfo .layer.crust {border-color: #8B4513;}
        #layerInfo .layer.mantle {border-color: #FF6B35;}
        #layerInfo .layer.outer-core {border-color: #FFC300;}
        #layerInfo .layer.inner-core {border-color: #FFFFFF;}
        #controls {position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); padding: 15px; border-radius: 12px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; backdrop-filter: blur(10px); box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 90vw;}
        .button-row {display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;}
        .slider-row {display: flex; width: 100%; padding: 8px 0;}
        button {padding: 12px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: bold; transition: all 0.3s; display: flex; align-items: center; gap: 6px; white-space: nowrap;}
        button:hover {background: #45a049; transform: scale(1.05);}
        button:active {transform: scale(0.95);}
        button.secondary {background: #2196F3;}
        button.secondary:hover {background: #1976D2;}
        button.open {background: #FF6B35;}
        button.open:hover {background: #FF5722;}
        input[type="range"] {-webkit-appearance: none; appearance: none; height: 6px; background: rgba(255,255,255,0.3); border-radius: 3px; outline: none;}
        input[type="range"]::-webkit-slider-thumb {-webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: #4CAF50; border-radius: 50%; cursor: pointer; transition: all 0.3s;}
        input[type="range"]::-webkit-slider-thumb:hover {background: #45a049; transform: scale(1.2);}
        #fileInput {display: none;}
        #instructions {position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.95); color: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 400px; z-index: 9998; backdrop-filter: blur(15px); box-shadow: 0 8px 32px rgba(0,0,0,0.5);}
        #instructions h2 {color: #4CAF50; margin-bottom: 15px;}
        #instructions ol {text-align: left; margin: 15px 0; padding-left: 25px;}
        #instructions li {margin: 10px 0; line-height: 1.6;}
        .marker-preview {width: 150px; height: 150px; margin: 15px auto; border: 3px solid #4CAF50; border-radius: 10px;}
        .tap-hint {position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%); background: rgba(255, 107, 53, 0.9); color: white; padding: 12px 24px; border-radius: 25px; font-size: 14px; font-weight: bold; z-index: 9999; animation: pulse 2s infinite; display: none;}
        @keyframes pulse {0%, 100% {transform: translateX(-50%) scale(1);} 50% {transform: translateX(-50%) scale(1.05);}}
    </style>
</head>
<body>
    <div id="instructions">
        <h2>üåç Edukasi Lapisan Bumi</h2>
        <div class="marker-preview">
            <svg viewBox="0 0 100 100" style="width:100%;height:100%">
                <rect width="100" height="100" fill="black"/>
                <rect x="15" y="15" width="70" height="70" fill="white"/>
                <text x="50" y="60" text-anchor="middle" font-size="24" font-weight="bold" fill="black">Hiro</text>
            </svg>
        </div>
        <ol>
            <li>Cetak/tampilkan <strong>Hiro Marker</strong></li>
            <li>Upload <strong>bumi.glb</strong></li>
            <li>Arahkan kamera ke marker</li>
            <li><strong>Ketuk bumi</strong> untuk membuka!</li>
        </ol>
        <button onclick="startAR()">üöÄ Mulai AR</button>
    </div>

    <a-scene id="arScene" embedded arjs="sourceType: webcam; debugUIEnabled: false;" vr-mode-ui="enabled: false" renderer="logarithmicDepthBuffer: true;" style="display: none;">
        <a-marker id="hiroMarker" preset="hiro" raycaster="objects: .clickable">
            <a-entity id="model" class="clickable" scale="2 2 2" animation="property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear"></a-entity>
        </a-marker>
        <a-entity camera raycaster="objects: .clickable"></a-entity>
    </a-scene>

    <div id="info" style="display: none;">
        <h3>üåç Lapisan Bumi 3D</h3>
        <p>Kamera: <span id="cameraStatus" class="status loading">Loading...</span></p>
        <p>Marker: <span id="markerStatus" class="status inactive">Cari Hiro</span></p>
        <p>Model: <span id="modelStatus" class="status inactive">Belum Upload</span></p>
        <p>Status: <span id="openStatus">Tertutup üîí</span></p>
    </div>

    <div id="layerInfo">
        <h4>üìö Lapisan Bumi</h4>
        <div class="layer crust"><strong>Kerak Bumi</strong><br>Ketebalan: 5-70 km</div>
        <div class="layer mantle"><strong>Mantel</strong><br>~2,900 km | 1,000-3,700¬∞C</div>
        <div class="layer outer-core"><strong>Inti Luar</strong><br>~2,200 km | 4,000-5,000¬∞C</div>
        <div class="layer inner-core"><strong>Inti Dalam</strong><br>~1,220 km | ~5,200¬∞C</div>
    </div>

    <div class="tap-hint" id="tapHint">üëÜ Ketuk Bumi!</div>

    <div id="controls" style="display: none;">
        <div class="button-row">
            <button onclick="document.getElementById('fileInput').click()">üìÅ Upload bumi.glb</button>
            <button class="open" onclick="toggleEarthOpen()"><span id="openButtonText">üîì Buka Lapisan</span></button>
            <button class="secondary" onclick="toggleRotation()">üîÑ <span id="rotationState">Rotasi ON</span></button>
        </div>
        <div class="slider-row">
            <label style="color: white; font-size: 12px; display: flex; align-items: center; gap: 8px; width: 100%;">
                üìè Ukuran: <span id="scaleValue">2.0</span>x
                <input type="range" id="scaleSlider" min="0.5" max="5" step="0.1" value="2" style="flex: 1; margin-left: 10px;" oninput="adjustScale(this.value)">
            </label>
        </div>
        <div class="slider-row">
            <label style="color: white; font-size: 12px; display: flex; align-items: center; gap: 8px; width: 100%;">
                üìÇ Buka: <span id="openValue">0</span>%
                <input type="range" id="openSlider" min="0" max="100" step="5" value="0" style="flex: 1; margin-left: 10px;" oninput="adjustOpenAmount(this.value)">
            </label>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".glb,.gltf">

    <script>
        let modelEntity, rotationEnabled = true, markerFound = false, isEarthOpen = false;

        AFRAME.registerComponent('earth-animator', {
            schema: {openAmount: {type: 'number', default: 0}},
            init: function() {
                this.model = null;
                this.layers = {
                    innerCore: null,
                    outerCore: [],
                    mantle: [],
                    crust: []
                };
                this.initialized = false;
            },
            update: function() {
                if (!this.model) return;
                
                if (!this.initialized) {
                    console.log('üîç Analyzing model structure...');
                    
                    // Kumpulkan semua mesh
                    const allMeshes = [];
                    this.model.traverse((c) => {
                        if (c.isMesh) {
                            if (!c.userData.orig) {
                                c.userData.orig = {
                                    pos: c.position.clone(),
                                    rot: c.rotation.clone(),
                                    scale: c.scale.clone()
                                };
                            }
                            allMeshes.push(c);
                        }
                    });
                    
                    console.log('üì¶ Total meshes:', allMeshes.length);
                    
                    // Kategorikan berdasarkan nama
                    allMeshes.forEach(mesh => {
                        const name = mesh.name;
                        console.log('  -', name, '| Pos:', mesh.position.x.toFixed(2), mesh.position.y.toFixed(2), mesh.position.z.toFixed(2));
                        
                        if (name === 'Inner_Core') {
                            this.layers.innerCore = mesh;
                        }
                        else if (name.includes('Outer')) {
                            this.layers.outerCore.push(mesh);
                        }
                        else if (name.includes('Mantle')) {
                            this.layers.mantle.push(mesh);
                        }
                        else if (name.includes('Sphere')) {
                            this.layers.crust.push(mesh);
                        }
                    });
                    
                    // Sort berdasarkan posisi X untuk menentukan kiri/kanan
                    this.layers.outerCore.sort((a, b) => a.position.x - b.position.x);
                    this.layers.mantle.sort((a, b) => a.position.x - b.position.x);
                    this.layers.crust.sort((a, b) => a.position.x - b.position.x);
                    
                    this.initialized = true;
                    console.log('‚úÖ Layers organized:');
                    console.log('   Inner Core:', this.layers.innerCore ? '‚úì' : '‚úó');
                    console.log('   Outer Core:', this.layers.outerCore.length, 'parts');
                    console.log('   Mantle:', this.layers.mantle.length, 'parts');
                    console.log('   Crust:', this.layers.crust.length, 'parts');
                }
                
                // ANIMASI
                const t = this.data.openAmount / 100;
                const baseGap = 2.5; // Gap dasar antar lapisan
                
                // Inner Core - tetap di tengah, sedikit membesar
                if (this.layers.innerCore) {
                    const orig = this.layers.innerCore.userData.orig;
                    this.layers.innerCore.position.copy(orig.pos);
                    this.layers.innerCore.rotation.copy(orig.rot);
                    const scale = 1 + t * 0.2;
                    this.layers.innerCore.scale.copy(orig.scale).multiplyScalar(scale);
                }
                
                // Outer Core - 2 bagian
                if (this.layers.outerCore.length >= 2) {
                    // Kiri
                    const origL = this.layers.outerCore[0].userData.orig;
                    this.layers.outerCore[0].position.set(
                        origL.pos.x - (t * baseGap * 1),
                        origL.pos.y,
                        origL.pos.z
                    );
                    this.layers.outerCore[0].rotation.copy(origL.rot);
                    
                    // Kanan
                    const origR = this.layers.outerCore[1].userData.orig;
                    this.layers.outerCore[1].position.set(
                        origR.pos.x + (t * baseGap * 1),
                        origR.pos.y,
                        origR.pos.z
                    );
                    this.layers.outerCore[1].rotation.copy(origR.rot);
                }
                
                // Mantle - 2 bagian
                if (this.layers.mantle.length >= 2) {
                    // Kiri
                    const origL = this.layers.mantle[0].userData.orig;
                    this.layers.mantle[0].position.set(
                        origL.pos.x - (t * baseGap * 2),
                        origL.pos.y,
                        origL.pos.z
                    );
                    this.layers.mantle[0].rotation.copy(origL.rot);
                    
                    // Kanan
                    const origR = this.layers.mantle[1].userData.orig;
                    this.layers.mantle[1].position.set(
                        origR.pos.x + (t * baseGap * 2),
                        origR.pos.y,
                        origR.pos.z
                    );
                    this.layers.mantle[1].rotation.copy(origR.rot);
                }
                
                // Crust - bisa 2 atau 4 bagian
                if (this.layers.crust.length >= 2) {
                    const halfPoint = Math.floor(this.layers.crust.length / 2);
                    
                    // Bagian kiri (setengah pertama)
                    for (let i = 0; i < halfPoint; i++) {
                        const mesh = this.layers.crust[i];
                        const orig = mesh.userData.orig;
                        mesh.position.set(
                            orig.pos.x - (t * baseGap * 3),
                            orig.pos.y,
                            orig.pos.z
                        );
                        mesh.rotation.y = orig.rot.y - (t * Math.PI / 6);
                    }
                    
                    // Bagian kanan (setengah kedua)
                    for (let i = halfPoint; i < this.layers.crust.length; i++) {
                        const mesh = this.layers.crust[i];
                        const orig = mesh.userData.orig;
                        mesh.position.set(
                            orig.pos.x + (t * baseGap * 3),
                            orig.pos.y,
                            orig.pos.z
                        );
                        mesh.rotation.y = orig.rot.y + (t * Math.PI / 6);
                    }
                }
                
                if (t > 0 && t < 1) {
                    console.log('üé¨ Opening:', (t * 100).toFixed(0) + '%');
                }
            }
        });

        function startAR() {
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('arScene').style.display = 'block';
            document.getElementById('info').style.display = 'block';
            document.getElementById('controls').style.display = 'flex';
            
            // Set slider ke 0 saat start
            document.getElementById('openSlider').value = 0;
            document.getElementById('openValue').textContent = 0;
            
            setTimeout(() => {
                document.getElementById('cameraStatus').className = 'status active'; 
                document.getElementById('cameraStatus').textContent = 'Aktif';
            }, 2000);
            
            const marker = document.querySelector('#hiroMarker');
            marker.addEventListener('markerFound', () => {
                markerFound = true; 
                document.getElementById('markerStatus').className = 'status active'; 
                document.getElementById('markerStatus').textContent = 'Terdeteksi ‚úì'; 
                document.getElementById('tapHint').style.display = 'block';
            });
            marker.addEventListener('markerLost', () => {
                markerFound = false; 
                document.getElementById('markerStatus').className = 'status inactive'; 
                document.getElementById('markerStatus').textContent = 'Hilang'; 
                document.getElementById('tapHint').style.display = 'none';
            });
            
            document.querySelector('a-scene').addEventListener('click', (e) => {
                if (markerFound && e.detail.intersection) toggleEarthOpen();
            });
        }

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            
            document.getElementById('modelStatus').className = 'status loading';
            document.getElementById('modelStatus').textContent = 'Loading...';
            
            const url = URL.createObjectURL(f);
            modelEntity = document.querySelector('#model');
            modelEntity.innerHTML = '';
            
            const gltf = document.createElement('a-gltf-model');
            gltf.setAttribute('src', url);
            gltf.classList.add('clickable');
            
            modelEntity.setAttribute('earth-animator', 'openAmount: 0');
            modelEntity.appendChild(gltf);
            
            gltf.addEventListener('model-loaded', (evt) => {
                document.getElementById('modelStatus').className = 'status active';
                document.getElementById('modelStatus').textContent = f.name + ' ‚úì';
                
                setTimeout(() => {
                    const comp = modelEntity.components['earth-animator'];
                    if (comp) {
                        comp.model = evt.detail.model;
                        comp.initialized = false;
                        comp.update();
                        console.log('üéâ Ready to animate!');
                        
                        // PAKSA reset ke posisi tertutup
                        setTimeout(() => {
                            adjustOpenAmount(0);
                            console.log('üîí Model reset to closed position');
                        }, 200);
                    }
                }, 500);
            });
        });

        function toggleRotation() {
            rotationEnabled = !rotationEnabled;
            const m = document.querySelector('#model');
            if (rotationEnabled) {
                m.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 10000; easing: linear');
                document.getElementById('rotationState').textContent = 'Rotasi ON';
            } else {
                m.removeAttribute('animation');
                document.getElementById('rotationState').textContent = 'Rotasi OFF';
            }
        }

        function toggleEarthOpen() {
            isEarthOpen = !isEarthOpen;
            const target = isEarthOpen ? 100 : 0;
            document.getElementById('openSlider').value = target;
            adjustOpenAmount(target);
            document.getElementById('openButtonText').textContent = isEarthOpen ? 'üîí Tutup' : 'üîì Buka';
            document.getElementById('openStatus').textContent = isEarthOpen ? 'Terbuka üîì' : 'Tertutup üîí';
            document.getElementById('layerInfo').style.display = isEarthOpen ? 'block' : 'none';
            document.getElementById('tapHint').style.display = isEarthOpen ? 'none' : 'block';
        }

        function adjustOpenAmount(v) {
            const m = document.querySelector('#model');
            if (m) m.setAttribute('earth-animator', `openAmount: ${v}`);
            document.getElementById('openValue').textContent = Math.round(v);
        }

        function adjustScale(v) {
            const m = document.querySelector('#model');
            if (m) {
                m.setAttribute('scale', `${v} ${v} ${v}`);
                document.getElementById('scaleValue').textContent = parseFloat(v).toFixed(1);
            }
        }
    </script>
</body>
</html>
